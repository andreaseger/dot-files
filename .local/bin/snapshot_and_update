#!/usr/bin/env bash
# Runs a command wrapped with btrfs pre-post snapshots.
log_path="/var/local/log/snp"
date=$(date "+%Y-%m-%d-%H%M%S")
log_file="${log_path}/snp_${date}.log"

# Log stdout and stderr. Reference: http://stackoverflow.com/questions/3173131/redirect-copy-of-stdout-to-log-file-from-within-bash-script-itself
exec >  >(tee -a "$log_file")
exec 2> >(tee -a "$log_file" >&2)

cmd="full-system-update (pacman -Syu && pacaur -Syua)"

snapshot_nbr_root=$(sudo snapper -c root create --type=pre --cleanup-algorithm=number --print-number --description="${cmd}")
snapshot_nbr_usr=$(sudo snapper -c usr create --type=pre --cleanup-algorithm=number --print-number --description="${cmd}")
echo -e "> New pre snapshots with number root:${snapshot_nbr_root} and usr:${snapshot_nbr_usr}."
echo -e "> Running command \"${cmd}\"."

if hash powerpill 2>/dev/null; then
  sudo powerpill -Syu
else
  sudo pacman -Syu
fi
pacaur -Syua

snapshot_nbr_root=$(sudo snapper -c root create --type=post --cleanup-algorithm=number --print-number --pre-number="$snapshot_nbr_root")
snapshot_nbr_usr=$(sudo snapper -c usr create --type=post --cleanup-algorithm=number --print-number --pre-number="$snapshot_nbr_usr")
echo -e "\n> New post snapshot with number root:${snapshot_nbr_root} and usr:${snapshot_nbr_usr}."
